(()=>{"use strict";const e=(e,t,c,n,o)=>{const a=e.createOscillator(),s={oct:o,n:t,oscillator:a,frequency:c,type:n,input:a,output:a,start:()=>{a.type=n,a.frequency.value=s.frequency*Math.pow(2,o-1),a.start()},changeType:e=>{a.type=e},changeFrequency:e=>{a.frequency.value=e},changeOctave:e=>{s.frequency=s.frequency*Math.pow(2,o-1)},connect:e=>{"input"in e?a.connect(e.input):(AudioParam,a.connect(e))}};return s},t=(e,t=.1)=>{const c=e.createGain(),n=c.gain;return n.value=t,{gain:c,input:c,output:c,amplitude:n,changeAmplitude:e=>{n.value=e},connect:e=>{"input"in e?c.connect(e.input):(AudioParam,c.connect(e))}}},c=e=>{let t=null;return{envOn:(c,n,o,a)=>{if(!t)return;const s=e.currentTime;t.cancelScheduledValues(s),t.setValueAtTime(0,s),t.linearRampToValueAtTime(a,s+c),t.linearRampToValueAtTime(a*o,s+c+n)},envOff:c=>{if(!t)return;const n=e.currentTime;t.cancelScheduledValues(0),t.setValueAtTime(t.value,n),t.linearRampToValueAtTime(0,n+c)},connect:e=>{t=e}}},n=(e,t=22)=>{const c=e.createBiquadFilter();return c.type="lowshelf",c.frequency.value=1e3*t,c.gain.value=20,{filter:c,frequency:c.frequency,input:c,output:c,changeFilter:e=>{c.frequency.value=e},connect:e=>{"input"in e?c.connect(e.input):(AudioParam,c.connect(e))}}},o=(e,t)=>{const c=e.createOscillator(),n=c.frequency;return c.frequency.value=t,{lfo:c,lfoFrequency:n,input:c,output:c,changeFrequency:e=>{n.value=e},connect:e=>{"input"in e?c.connect(e.input):(AudioParam,c.connect(e))},start:()=>{c.start()}}},a=(a,s,r,i,l,u,d,y,m,h,v,p,f,g)=>{const b=o(a,f),k=(e=>{const t=document.querySelector("#canvas"),c=e.createAnalyser();c.fftSize=2048;const n=c.frequencyBinCount,o=new Uint8Array(n),a=t.width,s=t.height;return{analyser:c,input:c,output:c,draw:(e,r)=>{let i="#ff00f7";r>300&&r<=400?i="#24ff00":r>400&&(i="#f8ff00"),c.getByteTimeDomainData(o),e.lineWidth=1.8,e.strokeStyle=i,e.beginPath();const l=1*a/n;let u=0;for(let t=0;t<n;t++){const c=o[t]/128*s/2;0===t?e.moveTo(u,c):e.lineTo(u,c),u+=l}e.lineTo(t.width,t.height/2),e.stroke()},connect:e=>{"input"in e?c.connect(e.input):(AudioParam,c.connect(e))}}})(a),q=t(a,g),S=e(a,s,r,l,m),L=e(a,s,r,u,h),w=t(a,d),V=t(a,y),A=c(a),O=c(a),F=n(a,v),T=n(a,p);return{frequency:r,context:a,n:s,volume:i,lfoVibrato:b,analyser:k,lfoVibratoAmp:q,oscillator1:S,oscillator2:L,amp1:w,amp2:V,envelope1:A,envelope2:O,filter1:F,filter2:T,connect:()=>{b.connect(q),q.connect(S.oscillator.frequency),q.connect(L.oscillator.frequency),A.connect(w.amplitude),O.connect(V.amplitude),S.connect(w),L.connect(V),w.connect(F),V.connect(T),F.connect(k),T.connect(k),k.connect(i)},changeFrequency:e=>{S.changeFrequency(e),L.changeFrequency(e)},start:e=>{A.envOn(e.attack,e.decay,e.sustain,w.amplitude.value),O.envOn(e.attack,e.decay,e.sustain,V.amplitude.value),S.start(),L.start(),b.start()},stop:e=>{A.envOff(e),O.envOff(e),setTimeout(()=>{S.oscillator.stop(),L.oscillator.stop(),b.lfo.disconnect(q.gain),q.gain.disconnect(S.oscillator.frequency),q.gain.disconnect(L.oscillator.frequency),S.oscillator.disconnect(w.gain),L.oscillator.disconnect(V.gain),w.gain.disconnect(F.filter),V.gain.disconnect(T.filter),F.filter.disconnect(k.analyser),T.filter.disconnect(k.analyser),k.analyser.disconnect(i.gain)},1e3*e)}}},s=new WeakMap,r=.75*Math.PI,i=1.5*Math.PI,l=(e,t)=>{const c=e.getContext("2d");if(!c)return;const{value:n,min:o,max:a}=t,s=(n-o)/(a-o),l=e.width,u=e.height,d=l/2,y=u/2,m=Math.min(l,u)/2-4;c.clearRect(0,0,l,u),c.beginPath(),c.arc(d,y,m,r,r+i),c.strokeStyle="#333",c.lineWidth=4,c.stroke(),s>0&&(c.beginPath(),c.arc(d,y,m,r,r+i*s),c.strokeStyle="#ff00f7",c.lineWidth=4,c.stroke());const h=t.step>=1?0:Math.max(0,Math.ceil(-Math.log10(t.step))),v=n.toFixed(h);c.fillStyle="white",c.font="9px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText(v,d,y)},u=(e,t,c=!1)=>{const n=s.get(e);n&&(n.value=Math.min(n.max,Math.max(n.min,t)),l(e,n),c&&n.onRelease(n.value))},d=(e,t)=>{const c=t?`canvas.knob[data-action="${e}"][data-osc="${t}"]`:`canvas.knob[data-action="${e}"]`;return document.querySelector(c)},y=(()=>{const e=document.querySelector("#canvas"),c=e.width,n=e.height,s=new AudioContext,r=s.createDynamicsCompressor();r.threshold.value=-45,r.knee.value=40,r.ratio.value=12,r.attack.value=.25,r.release.value=.25;const i=t(s),l={context:s,activeVoices:{},destination:s.destination,volume:i,compressor:r,tremoloAmp:t(s,0),tremoloLfo:o(s,0),vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine",osc1cutoff:22,osc2cutoff:22,osc1vol:.0416,osc2vol:.0208,osc1oct:1,osc2oct:2,envelope:{attack:0,decay:0,sustain:1,release:.5},start:e=>{const t=e.n,c=l.calculateFrequency(t);l.activeVoices[t]=a(s,t,c,i,l.osc1type,l.osc2type,l.osc1vol,l.osc2vol,l.osc1oct,l.osc2oct,l.osc1cutoff,l.osc2cutoff,l.vibratoSpeed,l.vibratoDepth),l.activeVoices[t].connect(),l.activeVoices[t].start(l.envelope)},draw:e=>{e.clearRect(0,0,c,n),Object.keys(l.activeVoices).forEach(t=>{const c=l.activeVoices[Number(t)];c.analyser.draw(e,c.frequency)})},updateFrequencies:e=>{const t=Object.keys(l.activeVoices);for(let c=0;c<t.length;c++){const n=l.activeVoices[Number(t[c])];n.n+=e;const o=l.calculateFrequency(n.n);n.changeFrequency(o)}},changeLFO:(e,t,c)=>{if("vibrato"===c)"speed"===t?l.vibratoSpeed=e:l.vibratoDepth=e;else if("tremolo"===c)if("speed"===t)l.tremoloSpeed=e,l.tremoloLfo.lfoFrequency.value=e;else{const t=e/1e3;l.tremoloDepth=t,l.tremoloAmp.gain.gain.value=t}const n=Object.keys(l.activeVoices);for(let e=0;e<n.length;e++)"vibrato"===c&&("speed"===t?l.activeVoices[Number(n[e])].lfoVibrato.changeFrequency(l.vibratoSpeed):l.activeVoices[Number(n[e])].lfoVibratoAmp.changeAmplitude(l.vibratoDepth))},changeOscVolume:(e,t)=>{1===t?l.osc1vol=e:l.osc2vol=e;const c=Object.keys(l.activeVoices);for(let e=0;e<c.length;e++)1===t?l.activeVoices[Number(c[e])].amp1.changeAmplitude(l.osc1vol):l.activeVoices[Number(c[e])].amp2.changeAmplitude(l.osc2vol)},changeOctave:(e,t)=>{1===t?l.osc1oct=e:l.osc2oct=e;const c=Object.keys(l.activeVoices);for(let e=0;e<c.length;e++)1===t?l.activeVoices[Number(c[e])].oscillator1.changeOctave(l.osc1oct):l.activeVoices[Number(c[e])].oscillator2.changeOctave(l.osc2oct)},changeCutoff:(e,t,c)=>{1===c?l.osc1cutoff=e:l.osc2cutoff=e;const n=Object.keys(l.activeVoices);for(let t=0;t<n.length;t++)1===c?l.activeVoices[Number(n[t])].filter1.changeFilter(e):l.activeVoices[Number(n[t])].filter2.changeFilter(e)},changeType:(e,t)=>{"1"===t?l.osc1type=e:l.osc2type=e},stop:e=>{e=l.handleOctaveChange(e),l.activeVoices[e].stop(l.envelope.release),delete l.activeVoices[e]},handleOctaveChange:e=>{let t=1;for(;!l.activeVoices[e];){const c=12;l.activeVoices[e+c*t]?e+=c*t:l.activeVoices[e-c*t]&&(e-=c*t),t+=1}return e},calculateFrequency:e=>440*Math.pow(2,(e-49)/12)};return l})(),m={synth:y,inc:0,ctx:document.querySelector("#canvas").getContext("2d"),lastTime:0,keys:{65:{down:!1,n:40,action:e=>m.startSynth(e)},87:{down:!1,n:41,action:e=>m.startSynth(e)},83:{down:!1,n:42,action:e=>m.startSynth(e)},69:{down:!1,n:43,action:e=>m.startSynth(e)},68:{down:!1,n:44,action:e=>m.startSynth(e)},70:{down:!1,n:45,action:e=>m.startSynth(e)},84:{down:!1,n:46,action:e=>m.startSynth(e)},71:{down:!1,n:47,action:e=>m.startSynth(e)},89:{down:!1,n:48,action:e=>m.startSynth(e)},72:{down:!1,n:49,action:e=>m.startSynth(e)},85:{down:!1,n:50,action:e=>m.startSynth(e)},74:{down:!1,n:51,action:e=>m.startSynth(e)},75:{down:!1,n:52,action:e=>m.startSynth(e)},79:{down:!1,n:53,action:e=>m.startSynth(e)},76:{down:!1,n:54,action:e=>m.startSynth(e)},80:{down:!1,n:55,action:e=>m.startSynth(e)},90:{down:!1,n:0,type:"octave",dir:"down",action:e=>m.octave(e)},88:{down:!1,n:0,type:"octave",dir:"up",action:e=>m.octave(e)}},animate:e=>{m.synth.draw(m.ctx),m.lastTime=e,requestAnimationFrame(m.animate)},octave:e=>{let t,c;"up"===e.dir?(t=m.synth.osc1oct+1,c=m.synth.osc2oct+1):(t=m.synth.osc1oct-1,c=m.synth.osc2oct-1),m.synth.changeOctave(t,1),m.synth.changeOctave(c,2)},increment:e=>{const t=Object.keys(m.keys);let c=Math.abs(m.inc-e);m.inc>e&&(c*=-1);for(let e=0;e<t.length;e++){const n=Number(t[e]);m.keys[n].incremented||(m.keys[n].origin=m.keys[n].n),m.synth.activeVoices[m.keys[n].n]&&(m.keys[n].incremented=!0);const o=m.keys[n].n+=c;o&&(m.keys[n].n=o)}m.synth.updateFrequencies(c),m.inc=e,m.updateKeyLettering()},updateKeyLettering:()=>{const e=["A","W","S","E","D","F","T","G","Y","H","U","J","K","O","L","P"],t=Object.keys(m.keys),c=m.keys[Number(t[0])].n,n=document.querySelectorAll("div[data-keynum]");for(let e=0;e<n.length;e++)n[e].innerHTML="";for(let t=0;t<e.length;t++){const n=`div[data-keynum="${t+c}"]`,o=document.querySelector(n);o&&(o.innerHTML=e[t])}},startSynth:e=>{m.synth.start(e),m.pushKey(e.n)},pushKey:e=>{const t=`div[data-key="${e}"]`,c=document.querySelector(t);null!==c&&(Array.from(c.classList).includes("black")?c.classList.add("playblack"):c.classList.add("playwhite"))},releaseKey:e=>{const t=`div[data-key="${e}"]`,c=document.querySelector(t);null!==c&&(Array.from(c.classList).includes("black")?c.classList.remove("playblack"):c.classList.remove("playwhite"))},setUpKnobs:()=>{document.querySelectorAll("canvas.knob").forEach(e=>{const t=e.dataset.action??"",c=parseFloat(e.dataset.min??"0"),n=parseFloat(e.dataset.max??"100"),o=parseFloat(e.dataset.step??"1"),a=parseFloat(e.dataset.value??"0");((e,t,c,n,o,a)=>{const r={value:o,min:t,max:c,step:n,onRelease:a};s.set(e,r),l(e,r);let i=0,u=0;const d=o=>{const a=i-o.clientY,s=c-t,d=Math.min(c,Math.max(t,u+a/150*s)),y=Math.round(d/n)*n;r.value=Math.min(c,Math.max(t,y)),l(e,r)},y=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",y),r.onRelease(r.value)};e.addEventListener("mousedown",e=>{i=e.clientY,u=r.value,document.addEventListener("mousemove",d),document.addEventListener("mouseup",y),e.preventDefault()})})(e,c,n,o,a,c=>{switch(t){case"tremolo-speed":y.changeLFO(c,"speed","tremolo");break;case"tremolo-depth":y.changeLFO(c,"depth","tremolo");break;case"vibrato-speed":y.changeLFO(c,"speed","vibrato");break;case"vibrato-depth":y.changeLFO(c,"depth","vibrato");break;case"tune":m.increment(c);break;case"attack":y.envelope.attack=2*c/100;break;case"decay":y.envelope.decay=3*c/100;break;case"sustain":y.envelope.sustain=c/100;break;case"release":y.envelope.release=2*c/100+.01;break;case"oscVolume":"1"===e.dataset.osc?y.changeOscVolume(c/1200,1):y.changeOscVolume(c/1200,2);break;case"octave":"1"===e.dataset.osc?y.changeOctave(c,1):y.changeOctave(c,2);break;case"cutoff":"1"===e.dataset.osc?y.changeCutoff(c,y.osc1res,1):y.changeCutoff(c,y.osc2res,2)}})})},setUpOscillatorTypes:()=>{document.querySelectorAll(".osctype").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget,c=t.getAttribute("data-type"),n=t.getAttribute("data-osc")??"";document.querySelectorAll(`div[data-osc="${n}"]`).forEach(e=>{e.classList.remove("active")}),y.changeType(c,n),t.classList.add("active")})})},clearActivePreset:()=>{document.querySelectorAll(".preset").forEach(e=>{Array.from(e.classList).includes("active")&&e.classList.remove("active")})},setUpShowHide:()=>{const e=document.querySelector(".envelope"),t=document.querySelector("h2"),c=document.querySelector(".oscillator-controls"),n=document.querySelector(".bottom-left"),o=document.querySelector(".bottom-right"),a=document.querySelector(".toggle-controls");a.addEventListener("click",()=>{Array.from(a.classList).includes("active")?(a.classList.remove("active"),a.innerHTML="HIDE",e?.classList.remove("hide"),c?.classList.remove("hide"),n?.classList.remove("hide"),o?.classList.remove("hide"),t?.classList.remove("hide")):(a.classList.add("active"),a.innerHTML="SHOW",e?.classList.add("hide"),n?.classList.add("hide"),o?.classList.add("hide"),c?.classList.add("hide"),t?.classList.add("hide"))})},setUpPresets:()=>{m.setUpShowHide(),document.querySelectorAll(".preset").forEach(e=>{e.addEventListener("click",()=>{switch(e.innerHTML){case"1":m.setPreset(0,7,55,10,50,1,9.18,18,4,12.91,6,5,0,0,"sine","sine");break;case"2":m.setPreset(32,7,55,10,40,1,16.74,55,3,12.89,3.5,6,6,76,"sawtooth","triangle");break;case"3":m.setPreset(0,7,55,10,40,1,9.18,55,2,12.91,2,2,8.5,84,"triangle","triangle");break;case"4":m.setPreset(0,5,0,10,40,1,9.18,55,3,18.88,0,0,0,0,"sawtooth","triangle");break;case"5":m.setPreset(24,0,100,10,40,1,6.62,55,3,11.83,3.5,2,1.5,45,"square","sawtooth")}m.clearActivePreset(),e.classList.add("active")})})},setPreset:(e,t,c,n,o,a,s,r,i,l,y,m,h,v,p,f)=>{u(d("attack"),e,!0),u(d("decay"),t,!0),u(d("sustain"),c,!0),u(d("release"),n,!0),u(d("oscVolume","1"),o,!0),u(d("oscVolume","2"),r,!0),u(d("octave","1"),a,!0),u(d("octave","2"),i,!0),u(d("cutoff","1"),s,!0),u(d("cutoff","1"),l,!0),u(d("tremolo-speed"),h,!0),u(d("tremolo-depth"),v,!0),u(d("vibrato-speed"),y,!0),u(d("vibrato-depth"),m,!0),document.querySelector(`.osctype[data-type="${p}"][data-osc="1"]`)?.click(),document.querySelector(`.osctype[data-type="${f}"][data-osc="2"]`)?.click()},start:()=>{const e=m.keys;m.setUpPresets(),m.setUpKnobs(),m.setUpOscillatorTypes(),requestAnimationFrame(m.animate),document.addEventListener("keydown",t=>{m.synth.context.resume();const c=e[t.keyCode];if(c){if(c.down)return;c.down=!0,c.action(c)}}),document.addEventListener("keyup",t=>{const c=e[t.keyCode];if(c){if(c.down=!1,"octave"===c.type)return;const e=c.n;c.incremented?(m.synth.stop(c.origin??e),m.releaseKey(c.origin??e),c.incremented=!1):(m.synth.stop(e),m.releaseKey(e))}}),m.synth.tremoloLfo.connect(m.synth.tremoloAmp),m.synth.tremoloAmp.connect(m.synth.volume.gain.gain),m.synth.volume.connect(m.synth.compressor),m.synth.compressor.connect(m.synth.context.destination),m.synth.tremoloLfo.start()}};document.addEventListener("DOMContentLoaded",()=>m.start())})();
//# sourceMappingURL=bundle.js.map