(()=>{"use strict";const e=(e,t,o,c,s)=>{const a=e.createOscillator(),n={oct:s,n:t,oscillator:a,frequency:o,type:c,input:a,output:a,start:()=>{a.type=c,a.frequency.value=n.frequency*Math.pow(2,s-1),a.start()},changeType:e=>{a.type=e},changeFrequency:e=>{a.frequency.value=e},changeOctave:e=>{n.oct=e,a.frequency.value=n.frequency*Math.pow(2,e-1)},connect:e=>{"input"in e?a.connect(e.input):(AudioParam,a.connect(e))}};return n},t=(e,t=.1)=>{const o=e.createGain(),c=o.gain;return c.value=t,{gain:o,input:o,output:o,amplitude:c,changeAmplitude:e=>{c.value=e},connect:e=>{"input"in e?o.connect(e.input):(AudioParam,o.connect(e))}}},o=e=>{let t=null;return{envOn:(o,c,s,a)=>{if(!t)return;const n=e.currentTime;t.cancelScheduledValues(n),t.setValueAtTime(0,n),t.linearRampToValueAtTime(a,n+o),t.linearRampToValueAtTime(a*s,n+o+c)},envOff:o=>{if(!t)return;const c=e.currentTime;t.cancelScheduledValues(0),t.setValueAtTime(t.value,c),t.linearRampToValueAtTime(0,c+o)},connect:e=>{t=e}}},c=(e,t=22)=>{const o=e.createBiquadFilter();return o.type="lowshelf",o.frequency.value=1e3*t,o.gain.value=20,{filter:o,frequency:o.frequency,input:o,output:o,changeFilter:e=>{o.frequency.value=1e3*e},connect:e=>{"input"in e?o.connect(e.input):(AudioParam,o.connect(e))}}},s=(e,t)=>{const o=e.createOscillator(),c=o.frequency;return o.frequency.value=t,{lfo:o,lfoFrequency:c,input:o,output:o,changeFrequency:e=>{c.value=e},connect:e=>{"input"in e?o.connect(e.input):(AudioParam,o.connect(e))},start:()=>{o.start()}}},a=(e,t)=>{const o=document.querySelector("#canvas"),c=e.createAnalyser();c.fftSize=4096,c.smoothingTimeConstant=0;const s=c.frequencyBinCount,a=new Uint8Array(s);return{analyser:c,input:c,output:c,draw:(e,t)=>{const n=o.width,r=o.height,i=window.devicePixelRatio||1;let l="#ff00f7";t>300&&t<=400?l="#24ff00":t>400&&(l="#f8ff00"),c.getByteTimeDomainData(a);let d=!1;for(let e=0;e<s;e++)if(Math.abs(a[e]-128)>2){d=!0;break}if(!d)return;e.lineWidth=3.5*i,e.strokeStyle=l,e.beginPath();const u=Math.ceil(e.lineWidth/2)+Math.round(.05*r),m=r-2*u,p=n/s;let v=0;for(let t=0;t<s;t++){const o=u+a[t]/128/2*m;0===t?e.moveTo(v,o):e.lineTo(v,o),v+=p}e.lineTo(n,r/2),e.stroke()},connect:e=>{"input"in e?c.connect(e.input):(AudioParam,c.connect(e))}}},n=(n,r,i,l,d,u,m,p,v,y,h,f,b,g,S,k)=>{const q=s(n,b),L=a(n),P=t(n,g),w=e(n,r,i,d,v),V=e(n,r,i,u,y),E=t(n,m),M=t(n,p),A=o(n),D=o(n),T=c(n,h),I=c(n,f);return{id:Math.random(),frequency:i,context:n,n:r,volume:l,lfoVibrato:q,analyser:L,lfoVibratoAmp:P,oscillator1:w,oscillator2:V,amp1:E,amp2:M,envelope1:A,envelope2:D,filter1:T,filter2:I,connect:()=>{q.connect(P),P.connect(w.oscillator.frequency),P.connect(V.oscillator.frequency),A.connect(E.amplitude),D.connect(M.amplitude),w.connect(E),V.connect(M),E.connect(T),M.connect(I),T.connect(L),I.connect(L),L.connect(l)},changeFrequency:e=>{w.changeFrequency(e),V.changeFrequency(e)},start:e=>{if(E.amplitude.value=0,M.amplitude.value=0,A.envOn(e.attack,e.decay,e.sustain,m),D.envOn(e.attack,e.decay,e.sustain,p),w.start(),V.start(),q.start(),k>0&&S>0){const e=n.currentTime,t=i*Math.pow(2,w.oct-1),o=S*Math.pow(2,w.oct-1);w.oscillator.frequency.cancelScheduledValues(e),w.oscillator.frequency.setValueAtTime(o,e),w.oscillator.frequency.exponentialRampToValueAtTime(t,e+k);const c=i*Math.pow(2,V.oct-1),s=S*Math.pow(2,V.oct-1);V.oscillator.frequency.cancelScheduledValues(e),V.oscillator.frequency.setValueAtTime(s,e),V.oscillator.frequency.exponentialRampToValueAtTime(c,e+k)}},retrigger:(e,t,o)=>{const c=n.currentTime,s=e*Math.pow(2,w.oct-1),a=e*Math.pow(2,V.oct-1);t>0?(w.oscillator.frequency.cancelScheduledValues(c),w.oscillator.frequency.setValueAtTime(w.oscillator.frequency.value,c),w.oscillator.frequency.exponentialRampToValueAtTime(s,c+t),V.oscillator.frequency.cancelScheduledValues(c),V.oscillator.frequency.setValueAtTime(V.oscillator.frequency.value,c),V.oscillator.frequency.exponentialRampToValueAtTime(a,c+t)):(w.oscillator.frequency.cancelScheduledValues(c),w.oscillator.frequency.setValueAtTime(s,c),V.oscillator.frequency.cancelScheduledValues(c),V.oscillator.frequency.setValueAtTime(a,c),A.envOn(o.attack,o.decay,o.sustain,m),D.envOn(o.attack,o.decay,o.sustain,p))},stop:e=>{A.envOff(e),D.envOff(e),setTimeout(()=>{w.oscillator.stop(),V.oscillator.stop(),q.lfo.disconnect(P.gain),P.gain.disconnect(w.oscillator.frequency),P.gain.disconnect(V.oscillator.frequency),w.oscillator.disconnect(E.gain),V.oscillator.disconnect(M.gain),E.gain.disconnect(T.filter),M.gain.disconnect(I.filter),T.filter.disconnect(L.analyser),I.filter.disconnect(L.analyser),L.analyser.disconnect(l.gain)},1e3*e)}}},r=new WeakMap,i=.75*Math.PI,l=1.5*Math.PI,d=(e,t)=>{const o=e.getContext("2d");if(!o)return;const{value:c,min:s,max:a}=t,n=(c-s)/(a-s),r=e.width,d=e.height,u=r/2,m=d/2,p=Math.min(r,d)/2-4,v=e.dataset.color??"#ff00f7",y=e.dataset.track??"#333",h=e.dataset.labelColor??"white";o.clearRect(0,0,r,d),o.beginPath(),o.arc(u,m,p,i,i+l),o.strokeStyle=y,o.lineWidth=4,o.stroke(),n>0&&(o.beginPath(),o.arc(u,m,p,i,i+l*n),o.strokeStyle=v,o.lineWidth=4,o.stroke());const f=t.step>=1?0:Math.max(0,Math.ceil(-Math.log10(t.step))),b=c.toFixed(f);o.fillStyle=h,o.font="9px sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText(b,u,m)},u=(e,t,o=!1)=>{const c=r.get(e);c&&(c.value=Math.min(c.max,Math.max(c.min,t)),d(e,c),o&&c.onRelease(c.value))},m=(e,t)=>{const o=t?`canvas.knob[data-action="${e}"][data-osc="${t}"]`:`canvas.knob[data-action="${e}"]`;return document.querySelector(o)},p=e=>{const t=r.get(e);t&&d(e,t)},v="synthviz-user-presets",y=[{id:"builtin-1",name:"Default",isBuiltIn:!0,params:{attack:0,decay:0,sustain:100,release:10,osc1vol:50,osc1oct:1,osc1cutoff:22,osc2vol:25,osc2oct:2,osc2cutoff:22,vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine",glide:0,mono:!1}},{id:"builtin-2",name:"Warm Pad",isBuiltIn:!0,params:{attack:0,decay:7,sustain:55,release:10,osc1vol:50,osc1oct:1,osc1cutoff:9.18,osc2vol:18,osc2oct:4,osc2cutoff:12.91,vibratoSpeed:6,vibratoDepth:5,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine",glide:0,mono:!1}},{id:"builtin-3",name:"Lead",isBuiltIn:!0,params:{attack:32,decay:7,sustain:55,release:10,osc1vol:40,osc1oct:1,osc1cutoff:16.74,osc2vol:55,osc2oct:3,osc2cutoff:12.89,vibratoSpeed:3.5,vibratoDepth:6,tremoloSpeed:6,tremoloDepth:76,osc1type:"sawtooth",osc2type:"triangle",glide:0,mono:!1}},{id:"builtin-4",name:"Bells",isBuiltIn:!0,params:{attack:0,decay:7,sustain:55,release:10,osc1vol:40,osc1oct:1,osc1cutoff:9.18,osc2vol:55,osc2oct:2,osc2cutoff:12.91,vibratoSpeed:2,vibratoDepth:2,tremoloSpeed:8.5,tremoloDepth:84,osc1type:"triangle",osc2type:"triangle",glide:0,mono:!1}},{id:"builtin-5",name:"Bass",isBuiltIn:!0,params:{attack:0,decay:5,sustain:0,release:10,osc1vol:40,osc1oct:1,osc1cutoff:9.18,osc2vol:55,osc2oct:3,osc2cutoff:18.88,vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sawtooth",osc2type:"triangle",glide:0,mono:!1}},{id:"builtin-6",name:"Arp",isBuiltIn:!0,params:{attack:24,decay:0,sustain:100,release:10,osc1vol:40,osc1oct:1,osc1cutoff:6.62,osc2vol:55,osc2oct:3,osc2cutoff:11.83,vibratoSpeed:3.5,vibratoDepth:2,tremoloSpeed:1.5,tremoloDepth:45,osc1type:"square",osc2type:"sawtooth",glide:0,mono:!1}}],h=()=>{try{const e=localStorage.getItem(v);return e?JSON.parse(e):[]}catch{return[]}},f=e=>{localStorage.setItem(v,JSON.stringify(e))},b=()=>[...y,...h()],g=()=>{const e=(e,t)=>{const o=m(e,t);return o?(e=>r.get(e)?.value??0)(o):0},t=document.querySelector('.osctype.active[data-osc="1"], .osctype.dirty[data-osc="1"]')?.dataset.type??"sine",o=document.querySelector('.osctype.active[data-osc="2"], .osctype.dirty[data-osc="2"]')?.dataset.type??"sine",c="true"===document.querySelector(".mono-btn")?.dataset.mono;return{attack:e("attack"),decay:e("decay"),sustain:e("sustain"),release:e("release"),osc1vol:e("oscVolume","1"),osc1oct:e("octave","1"),osc1cutoff:e("cutoff","1"),osc2vol:e("oscVolume","2"),osc2oct:e("octave","2"),osc2cutoff:e("cutoff","2"),vibratoSpeed:e("vibrato-speed"),vibratoDepth:e("vibrato-depth"),tremoloSpeed:e("tremolo-speed"),tremoloDepth:e("tremolo-depth"),osc1type:t,osc2type:o,glide:e("glide"),mono:c}},S=(()=>{let e=null,o=[];const c=document.querySelector("#canvas"),r=new AudioContext,i=r.createDynamicsCompressor();i.threshold.value=-45,i.knee.value=40,i.ratio.value=12,i.attack.value=.25,i.release.value=.25;const l=t(r),d=a(r),u=t(r,0),m=s(r,0);l.connect(d),d.connect(i),i.connect(r.destination),m.connect(u),u.connect(l.amplitude),m.start();const p={context:r,activeVoices:{},destination:r.destination,volume:l,compressor:i,masterAnalyser:d,tremoloAmp:u,tremoloLfo:m,vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine",osc1cutoff:22,osc2cutoff:22,osc1vol:.0416,osc2vol:.0208,osc1oct:1,osc2oct:2,envelope:{attack:0,decay:0,sustain:1,release:.5},glide:0,lastFrequency:0,mono:!1,start:t=>{const c=t.n,s=p.calculateFrequency(c);if(p.mono)return o=o.filter(e=>e!==c),o.push(c),void(e?c!==e.n&&(delete p.activeVoices[e.n],e.n=c,e.frequency=s,e.retrigger(s,p.glide,p.envelope),p.lastFrequency=s,p.activeVoices[c]=e):(e=n(r,c,s,l,p.osc1type,p.osc2type,p.osc1vol,p.osc2vol,p.osc1oct,p.osc2oct,p.osc1cutoff,p.osc2cutoff,p.vibratoSpeed,p.vibratoDepth,p.lastFrequency,p.glide),e.connect(),e.start(p.envelope),p.lastFrequency=s,p.activeVoices[c]=e));p.activeVoices[c]&&(p.activeVoices[c].stop(0),delete p.activeVoices[c]),p.activeVoices[c]=n(r,c,s,l,p.osc1type,p.osc2type,p.osc1vol,p.osc2vol,p.osc1oct,p.osc2oct,p.osc1cutoff,p.osc2cutoff,p.vibratoSpeed,p.vibratoDepth,p.lastFrequency,p.glide),p.activeVoices[c].connect(),p.activeVoices[c].start(p.envelope),p.lastFrequency=s},draw:e=>{e.clearRect(0,0,c.width,c.height),Object.keys(p.activeVoices).forEach(t=>{const o=p.activeVoices[Number(t)];o.analyser.draw(e,o.frequency)})},updateFrequencies:e=>{const t=Object.keys(p.activeVoices);for(let o=0;o<t.length;o++){const c=p.activeVoices[Number(t[o])];c.n+=e;const s=p.calculateFrequency(c.n);c.changeFrequency(s)}},changeLFO:(e,t,o)=>{if("vibrato"===o)"speed"===t?p.vibratoSpeed=e:p.vibratoDepth=e;else if("tremolo"===o)if("speed"===t)p.tremoloSpeed=e,p.tremoloLfo.lfoFrequency.value=e;else{const t=e/1e3;p.tremoloDepth=t,p.tremoloAmp.gain.gain.value=t}const c=Object.keys(p.activeVoices);for(let e=0;e<c.length;e++)"vibrato"===o&&("speed"===t?p.activeVoices[Number(c[e])].lfoVibrato.changeFrequency(p.vibratoSpeed):p.activeVoices[Number(c[e])].lfoVibratoAmp.changeAmplitude(p.vibratoDepth))},changeOscVolume:(e,t)=>{1===t?p.osc1vol=e:p.osc2vol=e;const o=Object.keys(p.activeVoices);for(let e=0;e<o.length;e++)1===t?p.activeVoices[Number(o[e])].amp1.changeAmplitude(p.osc1vol):p.activeVoices[Number(o[e])].amp2.changeAmplitude(p.osc2vol)},changeOctave:(e,t)=>{1===t?p.osc1oct=e:p.osc2oct=e;const o=Object.keys(p.activeVoices);for(let e=0;e<o.length;e++)1===t?p.activeVoices[Number(o[e])].oscillator1.changeOctave(p.osc1oct):p.activeVoices[Number(o[e])].oscillator2.changeOctave(p.osc2oct)},changeCutoff:(e,t,o)=>{1===o?p.osc1cutoff=e:p.osc2cutoff=e;const c=Object.keys(p.activeVoices);for(let t=0;t<c.length;t++)1===o?p.activeVoices[Number(c[t])].filter1.changeFilter(e):p.activeVoices[Number(c[t])].filter2.changeFilter(e)},changeType:(e,t)=>{"1"===t?p.osc1type=e:p.osc2type=e},stop:t=>{if(p.mono){o=o.filter(e=>e!==t);const c=p.activeVoices[t];if(c&&c!==e){const e=c.id;c.stop(p.envelope.release),setTimeout(()=>{p.activeVoices[t]?.id===e&&delete p.activeVoices[t]},1e3*p.envelope.release)}if(!e)return;if(o.length>0){const t=o[o.length-1];if(t!==e.n){delete p.activeVoices[e.n];const o=p.calculateFrequency(t);e.n=t,e.frequency=o,e.retrigger(o,p.glide,p.envelope),p.lastFrequency=o,p.activeVoices[t]=e}}else{const t=e.id,o=e.n;e.stop(p.envelope.release),e=null,setTimeout(()=>{p.activeVoices[o]?.id===t&&delete p.activeVoices[o]},1e3*p.envelope.release),p.lastFrequency=0}return}t=p.handleOctaveChange(t);const c=p.activeVoices[t];if(!c)return;const s=c.id;c.stop(p.envelope.release),setTimeout(()=>{p.activeVoices[t]?.id===s&&delete p.activeVoices[t]},1e3*p.envelope.release)},handleOctaveChange:e=>{if(p.activeVoices[e])return e;for(let t=1;t<=10;t++){if(p.activeVoices[e+12*t])return e+12*t;if(p.activeVoices[e-12*t])return e-12*t}return e},calculateFrequency:e=>440*Math.pow(2,(e-49)/12)};return p})(),k={synth:S,inc:0,ctx:document.querySelector("#canvas").getContext("2d"),lastTime:0,activePresetId:null,isDirty:!1,loadedPresetParams:null,keys:{65:{down:!1,n:40,action:e=>k.startSynth(e)},87:{down:!1,n:41,action:e=>k.startSynth(e)},83:{down:!1,n:42,action:e=>k.startSynth(e)},69:{down:!1,n:43,action:e=>k.startSynth(e)},68:{down:!1,n:44,action:e=>k.startSynth(e)},70:{down:!1,n:45,action:e=>k.startSynth(e)},84:{down:!1,n:46,action:e=>k.startSynth(e)},71:{down:!1,n:47,action:e=>k.startSynth(e)},89:{down:!1,n:48,action:e=>k.startSynth(e)},72:{down:!1,n:49,action:e=>k.startSynth(e)},85:{down:!1,n:50,action:e=>k.startSynth(e)},74:{down:!1,n:51,action:e=>k.startSynth(e)},75:{down:!1,n:52,action:e=>k.startSynth(e)},79:{down:!1,n:53,action:e=>k.startSynth(e)},76:{down:!1,n:54,action:e=>k.startSynth(e)},80:{down:!1,n:55,action:e=>k.startSynth(e)},90:{down:!1,n:0,type:"octave",dir:"down",action:e=>k.octave(e)},88:{down:!1,n:0,type:"octave",dir:"up",action:e=>k.octave(e)}},animate:e=>{k.synth.draw(k.ctx),k.lastTime=e,requestAnimationFrame(k.animate)},octave:e=>{let t,o;"up"===e.dir?(t=k.synth.osc1oct+1,o=k.synth.osc2oct+1):(t=k.synth.osc1oct-1,o=k.synth.osc2oct-1),k.synth.changeOctave(t,1),k.synth.changeOctave(o,2)},increment:e=>{const t=Object.keys(k.keys);let o=Math.abs(k.inc-e);k.inc>e&&(o*=-1);const c={};for(let e=0;e<t.length;e++){const s=Number(t[e]);c[s]=k.keys[s].n,k.keys[s].incremented||(k.keys[s].origin=k.keys[s].n),k.synth.activeVoices[k.keys[s].n]&&(k.keys[s].incremented=!0);const a=k.keys[s].n+=o;a&&(k.keys[s].n=a)}const s=[],a=[];for(let e=0;e<t.length;e++){const o=Number(t[e]);k.keys[o].down&&"octave"!==k.keys[o].type&&(s.push(c[o]),a.push(k.keys[o].n))}const n=new Set(a);s.forEach(e=>{n.has(e)||k.releaseKey(e)}),a.forEach(e=>k.pushKey(e)),k.synth.updateFrequencies(o),k.inc=e,k.updateKeyLettering()},updateKeyLettering:()=>{const e=["A","W","S","E","D","F","T","G","Y","H","U","J","K","O","L","P"],t=Object.keys(k.keys),o=k.keys[Number(t[0])].n,c=document.querySelectorAll("div[data-keynum]");for(let e=0;e<c.length;e++)c[e].innerHTML="";for(let t=0;t<e.length;t++){const c=`div[data-keynum="${t+o}"]`,s=document.querySelector(c);s&&(s.innerHTML=e[t])}},startSynth:e=>{k.synth.start(e),k.pushKey(e.n)},pushKey:e=>{const t=`div[data-key="${e}"]`,o=document.querySelector(t);null!==o&&(Array.from(o.classList).includes("black")?o.classList.add("playblack"):o.classList.add("playwhite"))},releaseKey:e=>{const t=`div[data-key="${e}"]`,o=document.querySelector(t);null!==o&&(Array.from(o.classList).includes("black")?o.classList.remove("playblack"):o.classList.remove("playwhite"))},updateMonoBtn:()=>{const e=document.querySelector(".mono-btn");if(e)if(e.classList.remove("active","dirty"),k.activePresetId&&k.loadedPresetParams){const t=k.loadedPresetParams.mono??!1;S.mono!==t?e.classList.add("dirty"):S.mono&&e.classList.add("active")}else S.mono&&e.classList.add("active")},applyKnobAction:(e,t,o)=>{switch(e){case"tremolo-speed":S.changeLFO(o,"speed","tremolo");break;case"tremolo-depth":S.changeLFO(o,"depth","tremolo");break;case"vibrato-speed":S.changeLFO(o,"speed","vibrato");break;case"vibrato-depth":S.changeLFO(o,"depth","vibrato");break;case"tune":k.increment(o);break;case"glide":S.glide=o;break;case"attack":S.envelope.attack=2*o/100;break;case"decay":S.envelope.decay=3*o/100;break;case"sustain":S.envelope.sustain=o/100;break;case"release":S.envelope.release=2*o/100+.01;break;case"oscVolume":"1"===t?S.changeOscVolume(o/1200,1):S.changeOscVolume(o/1200,2);break;case"octave":"1"===t?S.changeOctave(o,1):S.changeOctave(o,2);break;case"cutoff":"1"===t?S.changeCutoff(o,S.osc1res,1):S.changeCutoff(o,S.osc2res,2)}},getPresetValueForKnob:(e,t)=>{const o=k.loadedPresetParams;if(!o)return null;switch(e){case"attack":return o.attack;case"decay":return o.decay;case"sustain":return o.sustain;case"release":return o.release;case"oscVolume":return"1"===t?o.osc1vol:o.osc2vol;case"octave":return"1"===t?o.osc1oct:o.osc2oct;case"cutoff":return"1"===t?o.osc1cutoff:o.osc2cutoff;case"vibrato-speed":return o.vibratoSpeed;case"vibrato-depth":return o.vibratoDepth;case"tremolo-speed":return o.tremoloSpeed;case"tremolo-depth":return o.tremoloDepth;case"glide":return o.glide;default:return null}},recomputePresetButtonDirty:()=>{if(!k.activePresetId||!k.loadedPresetParams)return;const e=k.loadedPresetParams,t=g(),o=!(Math.abs(t.attack-e.attack)<.001&&Math.abs(t.decay-e.decay)<.001&&Math.abs(t.sustain-e.sustain)<.001&&Math.abs(t.release-e.release)<.001&&Math.abs(t.osc1vol-e.osc1vol)<.001&&Math.abs(t.osc1oct-e.osc1oct)<.001&&Math.abs(t.osc1cutoff-e.osc1cutoff)<.001&&Math.abs(t.osc2vol-e.osc2vol)<.001&&Math.abs(t.osc2oct-e.osc2oct)<.001&&Math.abs(t.osc2cutoff-e.osc2cutoff)<.001&&Math.abs(t.vibratoSpeed-e.vibratoSpeed)<.001&&Math.abs(t.vibratoDepth-e.vibratoDepth)<.001&&Math.abs(t.tremoloSpeed-e.tremoloSpeed)<.001&&Math.abs(t.tremoloDepth-e.tremoloDepth)<.001&&Math.abs(t.glide-e.glide)<.001&&t.osc1type===e.osc1type&&t.osc2type===e.osc2type&&t.mono===(e.mono??!1)),c=document.querySelector(`.preset[data-preset-id="${k.activePresetId}"]`);if(o){k.isDirty=!0,c&&(c.classList.remove("active"),c.classList.add("dirty"));const e=document.querySelector(".preset-save-btn"),t=document.querySelector(".preset-reset-btn");if(e){const t=y.some(e=>e.id===k.activePresetId);e.textContent=t?"SAVE AS NEW":"SAVE",e.classList.remove("hide")}t&&t.classList.remove("hide")}else k.isDirty=!1,c&&(c.classList.remove("dirty"),c.classList.add("active")),document.querySelector(".preset-save-btn")?.classList.add("hide"),document.querySelector(".preset-reset-btn")?.classList.add("hide");k.updateMonoBtn()},setUpKnobs:()=>{document.querySelectorAll("canvas.knob").forEach(e=>{const t=e.dataset.action??"",o=e.dataset.osc,c=parseFloat(e.dataset.min??"0"),s=parseFloat(e.dataset.max??"100"),a=parseFloat(e.dataset.step??"1"),n=parseFloat(e.dataset.value??"0");((e,t,o,c,s,a)=>{const n={value:s,min:t,max:o,step:c,onChange:a,onRelease:a};r.set(e,n),d(e,n);let i=0,l=0,u=0,m="unknown";const p=s=>{const a=i-s.clientY,r=o-t,l=Math.min(o,Math.max(t,u+a/150*r)),m=Math.round(l/c)*c;n.value=Math.min(o,Math.max(t,m)),d(e,n),n.onChange(n.value)},v=()=>{document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",v),n.onRelease(n.value)};e.addEventListener("mousedown",e=>{i=e.clientY,u=n.value,document.addEventListener("mousemove",p),document.addEventListener("mouseup",v),e.preventDefault()}),e.addEventListener("touchstart",e=>{i=e.touches[0].clientY,l=e.touches[0].clientX,u=n.value,m="unknown"},{passive:!0}),e.addEventListener("touchmove",s=>{const a=Math.abs(s.touches[0].clientX-l),r=Math.abs(s.touches[0].clientY-i);if("unknown"===m&&(m=a>r?"scroll":"knob"),"scroll"===m)return;s.preventDefault();const p=i-s.touches[0].clientY,v=o-t,y=Math.min(o,Math.max(t,u+p/150*v)),h=Math.round(y/c)*c;n.value=Math.min(o,Math.max(t,h)),d(e,n),n.onChange(n.value)},{passive:!1}),e.addEventListener("touchend",()=>{"knob"===m&&n.onRelease(n.value),m="unknown"})})(e,c,s,a,n,c=>{if(k.applyKnobAction(t,o,c),k.activePresetId&&k.loadedPresetParams){const s=k.getPresetValueForKnob(t,o);if(null!==s){const t=Math.abs(c-s)>=.5*a?"#ff9900":"#b4ff00";e.dataset.color!==t&&(e.dataset.color=t,p(e))}k.recomputePresetButtonDirty()}})})},setUpOscillatorTypes:()=>{document.querySelectorAll(".osctype").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget,o=t.getAttribute("data-type"),c=t.getAttribute("data-osc")??"";if(document.querySelectorAll(`div[data-osc="${c}"]`).forEach(e=>{e.classList.remove("active"),e.classList.remove("dirty")}),S.changeType(o,c),Object.values(S.activeVoices).forEach(e=>{"1"===c?e.oscillator1.changeType(o):e.oscillator2.changeType(o)}),k.activePresetId&&k.loadedPresetParams){const e="1"===c?k.loadedPresetParams.osc1type:k.loadedPresetParams.osc2type;t.classList.add(o!==e?"dirty":"active")}else t.classList.add("active");k.recomputePresetButtonDirty()})})},clearActivePreset:()=>{document.querySelectorAll(".preset").forEach(e=>{Array.from(e.classList).includes("active")&&e.classList.remove("active")})},setUpShowHide:()=>{const e=document.querySelector(".controls-strip"),t=document.querySelector(".envelope"),o=document.querySelector("h2"),c=document.querySelector(".oscillator-controls"),s=document.querySelector(".bottom-left"),a=document.querySelector(".bottom-right"),n=document.querySelector(".lfo-section"),r=document.querySelector(".toggle-controls");r.addEventListener("click",()=>{Array.from(r.classList).includes("active")?(r.classList.remove("active"),r.innerHTML="HIDE",e?(e.classList.remove("hide"),document.documentElement.style.removeProperty("--panel-height")):(t?.classList.remove("hide"),c?.classList.remove("hide"),s?.classList.remove("hide"),a?.classList.remove("hide"),n?.classList.remove("hide"),o?.classList.remove("hide"))):(r.classList.add("active"),r.innerHTML="SHOW",e?(e.classList.add("hide"),document.documentElement.style.setProperty("--panel-height","150px")):(t?.classList.add("hide"),s?.classList.add("hide"),a?.classList.add("hide"),c?.classList.add("hide"),n?.classList.add("hide"),o?.classList.add("hide")))})},renderPresets:()=>{const e=document.querySelector(".preset-row-builtin"),t=document.querySelector(".preset-row-user");if(!e||!t)return;e.innerHTML="",t.innerHTML="",y.forEach((t,o)=>{const c=document.createElement("div");c.className="preset",c.dataset.presetId=t.id,c.textContent=String(o+1),c.title=t.name,t.id===k.activePresetId&&(k.isDirty?c.classList.add("dirty"):c.classList.add("active")),e.appendChild(c)}),h().forEach(e=>{const o=document.createElement("div");o.className="preset user-preset",o.dataset.presetId=e.id,o.title=e.name;const c=document.createElement("span");c.className="preset-name-label",c.textContent=e.name;const s=document.createElement("span");s.className="preset-rename",s.textContent="✎",s.dataset.renameId=e.id;const a=document.createElement("span");a.className="preset-delete",a.textContent="×",a.dataset.deleteId=e.id,o.appendChild(c),o.appendChild(s),o.appendChild(a),e.id===k.activePresetId&&(k.isDirty?o.classList.add("dirty"):o.classList.add("active")),t.appendChild(o)});const o=document.createElement("div");o.className="preset preset-new",o.textContent="+",o.title="New preset from current state",t.appendChild(o)},showConfirm:e=>new Promise(t=>{let o=document.querySelector(".sv-confirm");o||(o=document.createElement("div"),o.className="sv-confirm hide",o.innerHTML='\n          <div class="sv-confirm-box">\n            <p class="sv-confirm-msg"></p>\n            <div class="sv-confirm-btns">\n              <button class="sv-confirm-cancel">CANCEL</button>\n              <button class="sv-confirm-ok">DELETE</button>\n            </div>\n          </div>',document.body.appendChild(o)),o.querySelector(".sv-confirm-msg").textContent=e,o.classList.remove("hide");const c=e=>{o.classList.add("hide"),t(e)};o.querySelector(".sv-confirm-ok").addEventListener("click",()=>c(!0),{once:!0}),o.querySelector(".sv-confirm-cancel").addEventListener("click",()=>c(!1),{once:!0}),o.addEventListener("click",e=>{e.target===o&&c(!1)},{once:!0}),document.addEventListener("keydown",e=>{"Escape"===e.key&&c(!1)},{once:!0})}),handlePresetRowClick:async e=>{const t=e.target;if(t.classList.contains("preset-delete")){const e=t.dataset.deleteId;if(!e)return;const o=b().find(t=>t.id===e);if(!o)return;if(!await k.showConfirm(`Delete "${o.name}"?`))return;const c=h().filter(t=>t.id!==e);return f(c),k.activePresetId===e&&(k.activePresetId=null,k.isDirty=!1,document.querySelector(".preset-save-btn")?.classList.add("hide"),document.querySelector(".preset-reset-btn")?.classList.add("hide")),void k.renderPresets()}if(t.classList.contains("preset-rename")){const e=t.dataset.renameId;return void(e&&k.startRename(e))}const o=t.closest(".preset");if(!o)return;if(o.classList.contains("preset-new"))return void k.newPreset();const c=o.dataset.presetId;if(!c)return;const s=b().find(e=>e.id===c);s&&k.loadPreset(s)},loadPreset:e=>{k.activePresetId=null,k.loadedPresetParams={...e.params};const t=e.params;k.setPreset(t.attack,t.decay,t.sustain,t.release,t.osc1vol,t.osc1oct,t.osc1cutoff,t.osc2vol,t.osc2oct,t.osc2cutoff,t.vibratoSpeed,t.vibratoDepth,t.tremoloSpeed,t.tremoloDepth,t.osc1type,t.osc2type,t.glide??0,t.mono??!1),k.activePresetId=e.id,k.clearDirtyState()},markDirty:e=>{k.recomputePresetButtonDirty()},clearDirtyState:()=>{k.isDirty=!1,document.querySelectorAll("canvas.knob").forEach(e=>{e.dataset.color="#b4ff00",p(e)}),document.querySelectorAll(".preset.dirty").forEach(e=>e.classList.remove("dirty")),document.querySelectorAll(".osctype.dirty").forEach(e=>e.classList.remove("dirty")),k.updateMonoBtn(),document.querySelector(".preset-save-btn")?.classList.add("hide"),document.querySelector(".preset-reset-btn")?.classList.add("hide"),document.querySelectorAll(".preset").forEach(e=>e.classList.remove("active")),k.activePresetId&&document.querySelector(`.preset[data-preset-id="${k.activePresetId}"]`)?.classList.add("active")},savePreset:()=>{const e=g();if(k.activePresetId&&!y.some(e=>e.id===k.activePresetId)&&k.activePresetId){const t=h(),o=t.findIndex(e=>e.id===k.activePresetId);o>=0&&(t[o].params=e,f(t),k.loadedPresetParams={...e}),k.clearDirtyState(),k.renderPresets()}else k.createNewPreset(e)},resetPreset:()=>{if(!k.activePresetId)return;const e=b().find(e=>e.id===k.activePresetId);e&&k.loadPreset(e)},createNewPreset:e=>{const t=h(),o=`Preset ${t.length+1}`,c=crypto.randomUUID();t.push({id:c,name:o,isBuiltIn:!1,params:e}),f(t),k.activePresetId=c,k.loadedPresetParams={...e},k.renderPresets(),k.clearDirtyState(),k.startRename(c)},newPreset:()=>{k.createNewPreset(g())},startRename:e=>{const t=document.querySelector(`.preset[data-preset-id="${e}"]`);if(!t)return;const o=h(),c=o.find(t=>t.id===e);if(!c)return;const s=document.createElement("input");s.type="text",s.value=c.name,s.className="preset-name-input";const a=()=>{const t=s.value.trim()||c.name,a=o.findIndex(t=>t.id===e);a>=0&&(o[a].name=t,f(o)),k.renderPresets()};s.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),a()),"Escape"===e.key&&k.renderPresets()}),s.addEventListener("blur",a),t.innerHTML="",t.appendChild(s),s.focus(),s.select()},setUpPresets:()=>{k.setUpShowHide();const e=document.querySelector(".preset-row");e?(k.renderPresets(),e.addEventListener("click",k.handlePresetRowClick),document.querySelector(".preset-save-btn")?.addEventListener("click",k.savePreset),document.querySelector(".preset-reset-btn")?.addEventListener("click",k.resetPreset)):document.querySelectorAll(".preset").forEach(e=>{e.addEventListener("click",()=>{switch(e.innerHTML){case"1":k.setPreset(0,0,100,10,50,1,22,25,2,22,0,0,0,0,"sine","sine");break;case"2":k.setPreset(0,7,55,10,50,1,9.18,18,4,12.91,6,5,0,0,"sine","sine");break;case"3":k.setPreset(32,7,55,10,40,1,16.74,55,3,12.89,3.5,6,6,76,"sawtooth","triangle");break;case"4":k.setPreset(0,7,55,10,40,1,9.18,55,2,12.91,2,2,8.5,84,"triangle","triangle");break;case"5":k.setPreset(0,5,0,10,40,1,9.18,55,3,18.88,0,0,0,0,"sawtooth","triangle");break;case"6":k.setPreset(24,0,100,10,40,1,6.62,55,3,11.83,3.5,2,1.5,45,"square","sawtooth")}k.clearActivePreset(),e.classList.add("active")})})},setPreset:(e,t,o,c,s,a,n,r,i,l,d,p,v,y,h,f,b=0,g=!1)=>{u(m("attack"),e,!0),u(m("decay"),t,!0),u(m("sustain"),o,!0),u(m("release"),c,!0),u(m("oscVolume","1"),s,!0),u(m("oscVolume","2"),r,!0),u(m("octave","1"),a,!0),u(m("octave","2"),i,!0),u(m("cutoff","1"),n,!0),u(m("cutoff","2"),l,!0),u(m("tremolo-speed"),v,!0),u(m("tremolo-depth"),y,!0),u(m("vibrato-speed"),d,!0),u(m("vibrato-depth"),p,!0),u(m("glide"),b,!0),S.mono=g;const k=document.querySelector(".mono-btn");k&&(k.dataset.mono=g.toString()),document.querySelector(`.osctype[data-type="${h}"][data-osc="1"]`)?.click(),document.querySelector(`.osctype[data-type="${f}"][data-osc="2"]`)?.click()},setUpKeyboard:()=>{const e=document.querySelector(".keyboard");if(!e)return;let t=null;const o=new Map,c=e=>{S.context.resume(),S.start({n:e,down:!1,action:()=>{}}),k.pushKey(e)},s=e=>{S.stop(e),k.releaseKey(e)};e.addEventListener("mousedown",e=>{const o=e.target.closest("[data-key]");if(!o)return;const s=parseInt(o.dataset.key??"");isNaN(s)||(e.preventDefault(),t=s,c(s))}),e.addEventListener("mouseover",e=>{if(null===t)return;const o=e.target.closest("[data-key]");if(!o)return;const a=parseInt(o.dataset.key??"");isNaN(a)||a===t||(s(t),t=a,c(a))}),document.addEventListener("mouseup",()=>{null!==t&&(s(t),t=null)}),e.addEventListener("touchstart",e=>{const t=e;t.preventDefault();for(const e of Array.from(t.changedTouches)){const t=document.elementFromPoint(e.clientX,e.clientY),s=t?.closest("[data-key]");if(!s)continue;const a=parseInt(s.dataset.key??"");isNaN(a)||o.has(e.identifier)||(o.set(e.identifier,a),c(a))}},{passive:!1}),document.addEventListener("touchmove",e=>{if(0!==o.size){e.preventDefault();for(const t of Array.from(e.changedTouches)){const e=o.get(t.identifier);if(void 0===e)continue;const a=document.elementFromPoint(t.clientX,t.clientY),n=a?.closest("[data-key]");if(!n)continue;const r=parseInt(n.dataset.key??"");isNaN(r)||r===e||(s(e),o.set(t.identifier,r),c(r))}}},{passive:!1});const a=e=>{for(const t of Array.from(e.changedTouches)){const e=o.get(t.identifier);void 0!==e&&(s(e),o.delete(t.identifier))}};document.addEventListener("touchend",a),document.addEventListener("touchcancel",a)},start:()=>{const e=document.querySelector("#canvas"),t=window.devicePixelRatio||1,o=e.getBoundingClientRect();e.width=Math.round(o.width*t),e.height=Math.round(o.height*t);const c=k.keys;k.setUpPresets(),k.setUpKnobs(),k.setUpOscillatorTypes(),k.setUpKeyboard();const s=document.querySelector(".mono-btn");s&&s.addEventListener("click",()=>{S.mono=!S.mono,s.dataset.mono=S.mono.toString(),k.updateMonoBtn(),k.recomputePresetButtonDirty()}),document.querySelector(".preset-row")?k.loadPreset(b()[0]):document.querySelector(".preset")?.click(),requestAnimationFrame(k.animate),document.addEventListener("keydown",e=>{k.synth.context.resume();const t=c[e.keyCode];if(t){if(t.down)return;t.down=!0,t.action(t)}}),document.addEventListener("keyup",e=>{const t=c[e.keyCode];if(t){if(t.down=!1,"octave"===t.type)return;const e=t.n;t.incremented?(k.synth.stop(t.origin??e),k.releaseKey(e),t.incremented=!1):(k.synth.stop(e),k.releaseKey(e))}}),k.synth.tremoloLfo.connect(k.synth.tremoloAmp),k.synth.tremoloAmp.connect(k.synth.volume.gain.gain),k.synth.volume.connect(k.synth.compressor),k.synth.compressor.connect(k.synth.context.destination),k.synth.tremoloLfo.start()}};document.addEventListener("DOMContentLoaded",()=>k.start())})();
//# sourceMappingURL=bundle.js.map