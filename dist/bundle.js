(()=>{"use strict";const e=(e,t,s,o,c)=>{const a=e.createOscillator(),n={oct:c,n:t,oscillator:a,frequency:s,type:o,input:a,output:a,start:()=>{a.type=o,a.frequency.value=n.frequency*Math.pow(2,c-1),a.start()},changeType:e=>{a.type=e},changeFrequency:e=>{a.frequency.value=e},changeOctave:e=>{n.oct=e,a.frequency.value=n.frequency*Math.pow(2,e-1)},connect:e=>{"input"in e?a.connect(e.input):(AudioParam,a.connect(e))}};return n},t=(e,t=.1)=>{const s=e.createGain(),o=s.gain;return o.value=t,{gain:s,input:s,output:s,amplitude:o,changeAmplitude:e=>{o.value=e},connect:e=>{"input"in e?s.connect(e.input):(AudioParam,s.connect(e))}}},s=e=>{let t=null;return{envOn:(s,o,c,a)=>{if(!t)return;const n=e.currentTime;t.cancelScheduledValues(n),t.setValueAtTime(0,n),t.linearRampToValueAtTime(a,n+s),t.linearRampToValueAtTime(a*c,n+s+o)},envOff:s=>{if(!t)return;const o=e.currentTime;t.cancelScheduledValues(0),t.setValueAtTime(t.value,o),t.linearRampToValueAtTime(0,o+s)},connect:e=>{t=e}}},o=(e,t=22)=>{const s=e.createBiquadFilter();return s.type="lowshelf",s.frequency.value=1e3*t,s.gain.value=20,{filter:s,frequency:s.frequency,input:s,output:s,changeFilter:e=>{s.frequency.value=1e3*e},connect:e=>{"input"in e?s.connect(e.input):(AudioParam,s.connect(e))}}},c=(e,t)=>{const s=e.createOscillator(),o=s.frequency;return s.frequency.value=t,{lfo:s,lfoFrequency:o,input:s,output:s,changeFrequency:e=>{o.value=e},connect:e=>{"input"in e?s.connect(e.input):(AudioParam,s.connect(e))},start:()=>{s.start()}}},a=(a,n,r,i,l,d,u,m,p,v,y,h,f,b)=>{const g=c(a,f),S=(e=>{const t=document.querySelector("#canvas"),s=e.createAnalyser();s.fftSize=4096,s.smoothingTimeConstant=0;const o=s.frequencyBinCount,c=new Uint8Array(o);return{analyser:s,input:s,output:s,draw:(e,a)=>{const n=t.width,r=t.height,i=window.devicePixelRatio||1;let l="#ff00f7";a>300&&a<=400?l="#24ff00":a>400&&(l="#f8ff00"),s.getByteTimeDomainData(c);let d=!1;for(let e=0;e<o;e++)if(Math.abs(c[e]-128)>2){d=!0;break}if(!d)return;e.lineWidth=3.5*i,e.strokeStyle=l,e.beginPath();const u=Math.ceil(e.lineWidth/2)+Math.round(.05*r),m=r-2*u,p=n/o;let v=0;for(let t=0;t<o;t++){const s=u+c[t]/128/2*m;0===t?e.moveTo(v,s):e.lineTo(v,s),v+=p}e.lineTo(n,r/2),e.stroke()},connect:e=>{"input"in e?s.connect(e.input):(AudioParam,s.connect(e))}}})(a),k=t(a,b),L=e(a,n,r,l,p),P=e(a,n,r,d,v),q=t(a,u),w=t(a,m),E=s(a),D=s(a),A=o(a,y),M=o(a,h);return{frequency:r,context:a,n,volume:i,lfoVibrato:g,analyser:S,lfoVibratoAmp:k,oscillator1:L,oscillator2:P,amp1:q,amp2:w,envelope1:E,envelope2:D,filter1:A,filter2:M,connect:()=>{g.connect(k),k.connect(L.oscillator.frequency),k.connect(P.oscillator.frequency),E.connect(q.amplitude),D.connect(w.amplitude),L.connect(q),P.connect(w),q.connect(A),w.connect(M),A.connect(S),M.connect(S),S.connect(i)},changeFrequency:e=>{L.changeFrequency(e),P.changeFrequency(e)},start:e=>{E.envOn(e.attack,e.decay,e.sustain,q.amplitude.value),D.envOn(e.attack,e.decay,e.sustain,w.amplitude.value),L.start(),P.start(),g.start()},stop:e=>{E.envOff(e),D.envOff(e),setTimeout(()=>{L.oscillator.stop(),P.oscillator.stop(),g.lfo.disconnect(k.gain),k.gain.disconnect(L.oscillator.frequency),k.gain.disconnect(P.oscillator.frequency),L.oscillator.disconnect(q.gain),P.oscillator.disconnect(w.gain),q.gain.disconnect(A.filter),w.gain.disconnect(M.filter),A.filter.disconnect(S.analyser),M.filter.disconnect(S.analyser),S.analyser.disconnect(i.gain)},1e3*e)}}},n=new WeakMap,r=.75*Math.PI,i=1.5*Math.PI,l=(e,t)=>{const s=e.getContext("2d");if(!s)return;const{value:o,min:c,max:a}=t,n=(o-c)/(a-c),l=e.width,d=e.height,u=l/2,m=d/2,p=Math.min(l,d)/2-4,v=e.dataset.color??"#ff00f7",y=e.dataset.track??"#333",h=e.dataset.labelColor??"white";s.clearRect(0,0,l,d),s.beginPath(),s.arc(u,m,p,r,r+i),s.strokeStyle=y,s.lineWidth=4,s.stroke(),n>0&&(s.beginPath(),s.arc(u,m,p,r,r+i*n),s.strokeStyle=v,s.lineWidth=4,s.stroke());const f=t.step>=1?0:Math.max(0,Math.ceil(-Math.log10(t.step))),b=o.toFixed(f);s.fillStyle=h,s.font="9px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText(b,u,m)},d=(e,t,s=!1)=>{const o=n.get(e);o&&(o.value=Math.min(o.max,Math.max(o.min,t)),l(e,o),s&&o.onRelease(o.value))},u=(e,t)=>{const s=t?`canvas.knob[data-action="${e}"][data-osc="${t}"]`:`canvas.knob[data-action="${e}"]`;return document.querySelector(s)},m=e=>{const t=n.get(e);t&&l(e,t)},p="synthviz-user-presets",v=[{id:"builtin-1",name:"Default",isBuiltIn:!0,params:{attack:0,decay:0,sustain:100,release:10,osc1vol:50,osc1oct:1,osc1cutoff:22,osc2vol:25,osc2oct:2,osc2cutoff:22,vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine"}},{id:"builtin-2",name:"Warm Pad",isBuiltIn:!0,params:{attack:0,decay:7,sustain:55,release:10,osc1vol:50,osc1oct:1,osc1cutoff:9.18,osc2vol:18,osc2oct:4,osc2cutoff:12.91,vibratoSpeed:6,vibratoDepth:5,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine"}},{id:"builtin-3",name:"Lead",isBuiltIn:!0,params:{attack:32,decay:7,sustain:55,release:10,osc1vol:40,osc1oct:1,osc1cutoff:16.74,osc2vol:55,osc2oct:3,osc2cutoff:12.89,vibratoSpeed:3.5,vibratoDepth:6,tremoloSpeed:6,tremoloDepth:76,osc1type:"sawtooth",osc2type:"triangle"}},{id:"builtin-4",name:"Bells",isBuiltIn:!0,params:{attack:0,decay:7,sustain:55,release:10,osc1vol:40,osc1oct:1,osc1cutoff:9.18,osc2vol:55,osc2oct:2,osc2cutoff:12.91,vibratoSpeed:2,vibratoDepth:2,tremoloSpeed:8.5,tremoloDepth:84,osc1type:"triangle",osc2type:"triangle"}},{id:"builtin-5",name:"Bass",isBuiltIn:!0,params:{attack:0,decay:5,sustain:0,release:10,osc1vol:40,osc1oct:1,osc1cutoff:9.18,osc2vol:55,osc2oct:3,osc2cutoff:18.88,vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sawtooth",osc2type:"triangle"}},{id:"builtin-6",name:"Arp",isBuiltIn:!0,params:{attack:24,decay:0,sustain:100,release:10,osc1vol:40,osc1oct:1,osc1cutoff:6.62,osc2vol:55,osc2oct:3,osc2cutoff:11.83,vibratoSpeed:3.5,vibratoDepth:2,tremoloSpeed:1.5,tremoloDepth:45,osc1type:"square",osc2type:"sawtooth"}}],y=()=>{try{const e=localStorage.getItem(p);return e?JSON.parse(e):[]}catch{return[]}},h=e=>{localStorage.setItem(p,JSON.stringify(e))},f=()=>[...v,...y()],b=()=>{const e=(e,t)=>{const s=u(e,t);return s?(e=>n.get(e)?.value??0)(s):0},t=document.querySelector('.osctype.active[data-osc="1"], .osctype.dirty[data-osc="1"]')?.dataset.type??"sine",s=document.querySelector('.osctype.active[data-osc="2"], .osctype.dirty[data-osc="2"]')?.dataset.type??"sine";return{attack:e("attack"),decay:e("decay"),sustain:e("sustain"),release:e("release"),osc1vol:e("oscVolume","1"),osc1oct:e("octave","1"),osc1cutoff:e("cutoff","1"),osc2vol:e("oscVolume","2"),osc2oct:e("octave","2"),osc2cutoff:e("cutoff","2"),vibratoSpeed:e("vibrato-speed"),vibratoDepth:e("vibrato-depth"),tremoloSpeed:e("tremolo-speed"),tremoloDepth:e("tremolo-depth"),osc1type:t,osc2type:s}},g=(()=>{const e=document.querySelector("#canvas"),s=new AudioContext,o=s.createDynamicsCompressor();o.threshold.value=-45,o.knee.value=40,o.ratio.value=12,o.attack.value=.25,o.release.value=.25;const n=t(s),r={context:s,activeVoices:{},destination:s.destination,volume:n,compressor:o,tremoloAmp:t(s,0),tremoloLfo:c(s,0),vibratoSpeed:0,vibratoDepth:0,tremoloSpeed:0,tremoloDepth:0,osc1type:"sine",osc2type:"sine",osc1cutoff:22,osc2cutoff:22,osc1vol:.0416,osc2vol:.0208,osc1oct:1,osc2oct:2,envelope:{attack:0,decay:0,sustain:1,release:.5},start:e=>{const t=e.n,o=r.calculateFrequency(t);r.activeVoices[t]&&(r.activeVoices[t].stop(0),delete r.activeVoices[t]),r.activeVoices[t]=a(s,t,o,n,r.osc1type,r.osc2type,r.osc1vol,r.osc2vol,r.osc1oct,r.osc2oct,r.osc1cutoff,r.osc2cutoff,r.vibratoSpeed,r.vibratoDepth),r.activeVoices[t].connect(),r.activeVoices[t].start(r.envelope)},draw:t=>{t.clearRect(0,0,e.width,e.height),Object.keys(r.activeVoices).forEach(e=>{const s=r.activeVoices[Number(e)];s.analyser.draw(t,s.frequency)})},updateFrequencies:e=>{const t=Object.keys(r.activeVoices);for(let s=0;s<t.length;s++){const o=r.activeVoices[Number(t[s])];o.n+=e;const c=r.calculateFrequency(o.n);o.changeFrequency(c)}},changeLFO:(e,t,s)=>{if("vibrato"===s)"speed"===t?r.vibratoSpeed=e:r.vibratoDepth=e;else if("tremolo"===s)if("speed"===t)r.tremoloSpeed=e,r.tremoloLfo.lfoFrequency.value=e;else{const t=e/1e3;r.tremoloDepth=t,r.tremoloAmp.gain.gain.value=t}const o=Object.keys(r.activeVoices);for(let e=0;e<o.length;e++)"vibrato"===s&&("speed"===t?r.activeVoices[Number(o[e])].lfoVibrato.changeFrequency(r.vibratoSpeed):r.activeVoices[Number(o[e])].lfoVibratoAmp.changeAmplitude(r.vibratoDepth))},changeOscVolume:(e,t)=>{1===t?r.osc1vol=e:r.osc2vol=e;const s=Object.keys(r.activeVoices);for(let e=0;e<s.length;e++)1===t?r.activeVoices[Number(s[e])].amp1.changeAmplitude(r.osc1vol):r.activeVoices[Number(s[e])].amp2.changeAmplitude(r.osc2vol)},changeOctave:(e,t)=>{1===t?r.osc1oct=e:r.osc2oct=e;const s=Object.keys(r.activeVoices);for(let e=0;e<s.length;e++)1===t?r.activeVoices[Number(s[e])].oscillator1.changeOctave(r.osc1oct):r.activeVoices[Number(s[e])].oscillator2.changeOctave(r.osc2oct)},changeCutoff:(e,t,s)=>{1===s?r.osc1cutoff=e:r.osc2cutoff=e;const o=Object.keys(r.activeVoices);for(let t=0;t<o.length;t++)1===s?r.activeVoices[Number(o[t])].filter1.changeFilter(e):r.activeVoices[Number(o[t])].filter2.changeFilter(e)},changeType:(e,t)=>{"1"===t?r.osc1type=e:r.osc2type=e},stop:e=>{e=r.handleOctaveChange(e);const t=r.activeVoices[e];t&&(t.stop(r.envelope.release),delete r.activeVoices[e])},handleOctaveChange:e=>{if(r.activeVoices[e])return e;for(let t=1;t<=10;t++){if(r.activeVoices[e+12*t])return e+12*t;if(r.activeVoices[e-12*t])return e-12*t}return e},calculateFrequency:e=>440*Math.pow(2,(e-49)/12)};return r})(),S={synth:g,inc:0,ctx:document.querySelector("#canvas").getContext("2d"),lastTime:0,activePresetId:null,isDirty:!1,loadedPresetParams:null,keys:{65:{down:!1,n:40,action:e=>S.startSynth(e)},87:{down:!1,n:41,action:e=>S.startSynth(e)},83:{down:!1,n:42,action:e=>S.startSynth(e)},69:{down:!1,n:43,action:e=>S.startSynth(e)},68:{down:!1,n:44,action:e=>S.startSynth(e)},70:{down:!1,n:45,action:e=>S.startSynth(e)},84:{down:!1,n:46,action:e=>S.startSynth(e)},71:{down:!1,n:47,action:e=>S.startSynth(e)},89:{down:!1,n:48,action:e=>S.startSynth(e)},72:{down:!1,n:49,action:e=>S.startSynth(e)},85:{down:!1,n:50,action:e=>S.startSynth(e)},74:{down:!1,n:51,action:e=>S.startSynth(e)},75:{down:!1,n:52,action:e=>S.startSynth(e)},79:{down:!1,n:53,action:e=>S.startSynth(e)},76:{down:!1,n:54,action:e=>S.startSynth(e)},80:{down:!1,n:55,action:e=>S.startSynth(e)},90:{down:!1,n:0,type:"octave",dir:"down",action:e=>S.octave(e)},88:{down:!1,n:0,type:"octave",dir:"up",action:e=>S.octave(e)}},animate:e=>{S.synth.draw(S.ctx),S.lastTime=e,requestAnimationFrame(S.animate)},octave:e=>{let t,s;"up"===e.dir?(t=S.synth.osc1oct+1,s=S.synth.osc2oct+1):(t=S.synth.osc1oct-1,s=S.synth.osc2oct-1),S.synth.changeOctave(t,1),S.synth.changeOctave(s,2)},increment:e=>{const t=Object.keys(S.keys);let s=Math.abs(S.inc-e);S.inc>e&&(s*=-1);const o={};for(let e=0;e<t.length;e++){const c=Number(t[e]);o[c]=S.keys[c].n,S.keys[c].incremented||(S.keys[c].origin=S.keys[c].n),S.synth.activeVoices[S.keys[c].n]&&(S.keys[c].incremented=!0);const a=S.keys[c].n+=s;a&&(S.keys[c].n=a)}const c=[],a=[];for(let e=0;e<t.length;e++){const s=Number(t[e]);S.keys[s].down&&"octave"!==S.keys[s].type&&(c.push(o[s]),a.push(S.keys[s].n))}const n=new Set(a);c.forEach(e=>{n.has(e)||S.releaseKey(e)}),a.forEach(e=>S.pushKey(e)),S.synth.updateFrequencies(s),S.inc=e,S.updateKeyLettering()},updateKeyLettering:()=>{const e=["A","W","S","E","D","F","T","G","Y","H","U","J","K","O","L","P"],t=Object.keys(S.keys),s=S.keys[Number(t[0])].n,o=document.querySelectorAll("div[data-keynum]");for(let e=0;e<o.length;e++)o[e].innerHTML="";for(let t=0;t<e.length;t++){const o=`div[data-keynum="${t+s}"]`,c=document.querySelector(o);c&&(c.innerHTML=e[t])}},startSynth:e=>{S.synth.start(e),S.pushKey(e.n)},pushKey:e=>{const t=`div[data-key="${e}"]`,s=document.querySelector(t);null!==s&&(Array.from(s.classList).includes("black")?s.classList.add("playblack"):s.classList.add("playwhite"))},releaseKey:e=>{const t=`div[data-key="${e}"]`,s=document.querySelector(t);null!==s&&(Array.from(s.classList).includes("black")?s.classList.remove("playblack"):s.classList.remove("playwhite"))},applyKnobAction:(e,t,s)=>{switch(e){case"tremolo-speed":g.changeLFO(s,"speed","tremolo");break;case"tremolo-depth":g.changeLFO(s,"depth","tremolo");break;case"vibrato-speed":g.changeLFO(s,"speed","vibrato");break;case"vibrato-depth":g.changeLFO(s,"depth","vibrato");break;case"tune":S.increment(s);break;case"attack":g.envelope.attack=2*s/100;break;case"decay":g.envelope.decay=3*s/100;break;case"sustain":g.envelope.sustain=s/100;break;case"release":g.envelope.release=2*s/100+.01;break;case"oscVolume":"1"===t?g.changeOscVolume(s/1200,1):g.changeOscVolume(s/1200,2);break;case"octave":"1"===t?g.changeOctave(s,1):g.changeOctave(s,2);break;case"cutoff":"1"===t?g.changeCutoff(s,g.osc1res,1):g.changeCutoff(s,g.osc2res,2)}},getPresetValueForKnob:(e,t)=>{const s=S.loadedPresetParams;if(!s)return null;switch(e){case"attack":return s.attack;case"decay":return s.decay;case"sustain":return s.sustain;case"release":return s.release;case"oscVolume":return"1"===t?s.osc1vol:s.osc2vol;case"octave":return"1"===t?s.osc1oct:s.osc2oct;case"cutoff":return"1"===t?s.osc1cutoff:s.osc2cutoff;case"vibrato-speed":return s.vibratoSpeed;case"vibrato-depth":return s.vibratoDepth;case"tremolo-speed":return s.tremoloSpeed;case"tremolo-depth":return s.tremoloDepth;default:return null}},recomputePresetButtonDirty:()=>{if(!S.activePresetId||!S.loadedPresetParams)return;const e=S.loadedPresetParams,t=b(),s=!(Math.abs(t.attack-e.attack)<.001&&Math.abs(t.decay-e.decay)<.001&&Math.abs(t.sustain-e.sustain)<.001&&Math.abs(t.release-e.release)<.001&&Math.abs(t.osc1vol-e.osc1vol)<.001&&Math.abs(t.osc1oct-e.osc1oct)<.001&&Math.abs(t.osc1cutoff-e.osc1cutoff)<.001&&Math.abs(t.osc2vol-e.osc2vol)<.001&&Math.abs(t.osc2oct-e.osc2oct)<.001&&Math.abs(t.osc2cutoff-e.osc2cutoff)<.001&&Math.abs(t.vibratoSpeed-e.vibratoSpeed)<.001&&Math.abs(t.vibratoDepth-e.vibratoDepth)<.001&&Math.abs(t.tremoloSpeed-e.tremoloSpeed)<.001&&Math.abs(t.tremoloDepth-e.tremoloDepth)<.001&&t.osc1type===e.osc1type&&t.osc2type===e.osc2type),o=document.querySelector(`.preset[data-preset-id="${S.activePresetId}"]`);if(s){S.isDirty=!0,o&&(o.classList.remove("active"),o.classList.add("dirty"));const e=document.querySelector(".preset-save-btn"),t=document.querySelector(".preset-reset-btn");if(e){const t=v.some(e=>e.id===S.activePresetId);e.textContent=t?"SAVE AS NEW":"SAVE",e.classList.remove("hide")}t&&t.classList.remove("hide")}else S.isDirty=!1,o&&(o.classList.remove("dirty"),o.classList.add("active")),document.querySelector(".preset-save-btn")?.classList.add("hide"),document.querySelector(".preset-reset-btn")?.classList.add("hide")},setUpKnobs:()=>{document.querySelectorAll("canvas.knob").forEach(e=>{const t=e.dataset.action??"",s=e.dataset.osc,o=parseFloat(e.dataset.min??"0"),c=parseFloat(e.dataset.max??"100"),a=parseFloat(e.dataset.step??"1"),r=parseFloat(e.dataset.value??"0");((e,t,s,o,c,a)=>{const r={value:c,min:t,max:s,step:o,onChange:a,onRelease:a};n.set(e,r),l(e,r);let i=0,d=0;const u=c=>{const a=i-c.clientY,n=s-t,u=Math.min(s,Math.max(t,d+a/150*n)),m=Math.round(u/o)*o;r.value=Math.min(s,Math.max(t,m)),l(e,r),r.onChange(r.value)},m=()=>{document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",m),r.onRelease(r.value)};e.addEventListener("mousedown",e=>{i=e.clientY,d=r.value,document.addEventListener("mousemove",u),document.addEventListener("mouseup",m),e.preventDefault()}),e.addEventListener("touchstart",e=>{i=e.touches[0].clientY,d=r.value,e.preventDefault()},{passive:!1}),e.addEventListener("touchmove",c=>{const a=i-c.touches[0].clientY,n=s-t,u=Math.min(s,Math.max(t,d+a/150*n)),m=Math.round(u/o)*o;r.value=Math.min(s,Math.max(t,m)),l(e,r),r.onChange(r.value),c.preventDefault()},{passive:!1}),e.addEventListener("touchend",()=>{r.onRelease(r.value)})})(e,o,c,a,r,o=>{if(S.applyKnobAction(t,s,o),S.activePresetId&&S.loadedPresetParams){const c=S.getPresetValueForKnob(t,s);if(null!==c){const t=Math.abs(o-c)>=.5*a?"#ff9900":"#b4ff00";e.dataset.color!==t&&(e.dataset.color=t,m(e))}S.recomputePresetButtonDirty()}})})},setUpOscillatorTypes:()=>{document.querySelectorAll(".osctype").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget,s=t.getAttribute("data-type"),o=t.getAttribute("data-osc")??"";if(document.querySelectorAll(`div[data-osc="${o}"]`).forEach(e=>{e.classList.remove("active"),e.classList.remove("dirty")}),g.changeType(s,o),Object.values(g.activeVoices).forEach(e=>{"1"===o?e.oscillator1.changeType(s):e.oscillator2.changeType(s)}),S.activePresetId&&S.loadedPresetParams){const e="1"===o?S.loadedPresetParams.osc1type:S.loadedPresetParams.osc2type;t.classList.add(s!==e?"dirty":"active")}else t.classList.add("active");S.recomputePresetButtonDirty()})})},clearActivePreset:()=>{document.querySelectorAll(".preset").forEach(e=>{Array.from(e.classList).includes("active")&&e.classList.remove("active")})},setUpShowHide:()=>{const e=document.querySelector(".controls-strip"),t=document.querySelector(".envelope"),s=document.querySelector("h2"),o=document.querySelector(".oscillator-controls"),c=document.querySelector(".bottom-left"),a=document.querySelector(".bottom-right"),n=document.querySelector(".lfo-section"),r=document.querySelector(".toggle-controls");r.addEventListener("click",()=>{Array.from(r.classList).includes("active")?(r.classList.remove("active"),r.innerHTML="HIDE",e?(e.classList.remove("hide"),document.documentElement.style.removeProperty("--panel-height")):(t?.classList.remove("hide"),o?.classList.remove("hide"),c?.classList.remove("hide"),a?.classList.remove("hide"),n?.classList.remove("hide"),s?.classList.remove("hide"))):(r.classList.add("active"),r.innerHTML="SHOW",e?(e.classList.add("hide"),document.documentElement.style.setProperty("--panel-height","150px")):(t?.classList.add("hide"),c?.classList.add("hide"),a?.classList.add("hide"),o?.classList.add("hide"),n?.classList.add("hide"),s?.classList.add("hide")))})},renderPresets:()=>{const e=document.querySelector(".preset-row-builtin"),t=document.querySelector(".preset-row-user");if(!e||!t)return;e.innerHTML="",t.innerHTML="",v.forEach((t,s)=>{const o=document.createElement("div");o.className="preset",o.dataset.presetId=t.id,o.textContent=String(s+1),o.title=t.name,t.id===S.activePresetId&&(S.isDirty?o.classList.add("dirty"):o.classList.add("active")),e.appendChild(o)}),y().forEach(e=>{const s=document.createElement("div");s.className="preset user-preset",s.dataset.presetId=e.id,s.title=e.name;const o=document.createElement("span");o.className="preset-name-label",o.textContent=e.name;const c=document.createElement("span");c.className="preset-rename",c.textContent="✎",c.dataset.renameId=e.id;const a=document.createElement("span");a.className="preset-delete",a.textContent="×",a.dataset.deleteId=e.id,s.appendChild(o),s.appendChild(c),s.appendChild(a),e.id===S.activePresetId&&(S.isDirty?s.classList.add("dirty"):s.classList.add("active")),t.appendChild(s)});const s=document.createElement("div");s.className="preset preset-new",s.textContent="+",s.title="New preset from current state",t.appendChild(s)},showConfirm:e=>new Promise(t=>{let s=document.querySelector(".sv-confirm");s||(s=document.createElement("div"),s.className="sv-confirm hide",s.innerHTML='\n          <div class="sv-confirm-box">\n            <p class="sv-confirm-msg"></p>\n            <div class="sv-confirm-btns">\n              <button class="sv-confirm-cancel">CANCEL</button>\n              <button class="sv-confirm-ok">DELETE</button>\n            </div>\n          </div>',document.body.appendChild(s)),s.querySelector(".sv-confirm-msg").textContent=e,s.classList.remove("hide");const o=e=>{s.classList.add("hide"),t(e)};s.querySelector(".sv-confirm-ok").addEventListener("click",()=>o(!0),{once:!0}),s.querySelector(".sv-confirm-cancel").addEventListener("click",()=>o(!1),{once:!0}),s.addEventListener("click",e=>{e.target===s&&o(!1)},{once:!0}),document.addEventListener("keydown",e=>{"Escape"===e.key&&o(!1)},{once:!0})}),handlePresetRowClick:async e=>{const t=e.target;if(t.classList.contains("preset-delete")){const e=t.dataset.deleteId;if(!e)return;const s=f().find(t=>t.id===e);if(!s)return;if(!await S.showConfirm(`Delete "${s.name}"?`))return;const o=y().filter(t=>t.id!==e);return h(o),S.activePresetId===e&&(S.activePresetId=null,S.isDirty=!1,document.querySelector(".preset-save-btn")?.classList.add("hide"),document.querySelector(".preset-reset-btn")?.classList.add("hide")),void S.renderPresets()}if(t.classList.contains("preset-rename")){const e=t.dataset.renameId;return void(e&&S.startRename(e))}const s=t.closest(".preset");if(!s)return;if(s.classList.contains("preset-new"))return void S.newPreset();const o=s.dataset.presetId;if(!o)return;const c=f().find(e=>e.id===o);c&&S.loadPreset(c)},loadPreset:e=>{S.activePresetId=null,S.loadedPresetParams={...e.params};const t=e.params;S.setPreset(t.attack,t.decay,t.sustain,t.release,t.osc1vol,t.osc1oct,t.osc1cutoff,t.osc2vol,t.osc2oct,t.osc2cutoff,t.vibratoSpeed,t.vibratoDepth,t.tremoloSpeed,t.tremoloDepth,t.osc1type,t.osc2type),S.activePresetId=e.id,S.clearDirtyState()},markDirty:e=>{S.recomputePresetButtonDirty()},clearDirtyState:()=>{S.isDirty=!1,document.querySelectorAll("canvas.knob").forEach(e=>{e.dataset.color="#b4ff00",m(e)}),document.querySelectorAll(".preset.dirty").forEach(e=>e.classList.remove("dirty")),document.querySelectorAll(".osctype.dirty").forEach(e=>e.classList.remove("dirty")),document.querySelector(".preset-save-btn")?.classList.add("hide"),document.querySelector(".preset-reset-btn")?.classList.add("hide"),document.querySelectorAll(".preset").forEach(e=>e.classList.remove("active")),S.activePresetId&&document.querySelector(`.preset[data-preset-id="${S.activePresetId}"]`)?.classList.add("active")},savePreset:()=>{const e=b();if(S.activePresetId&&!v.some(e=>e.id===S.activePresetId)&&S.activePresetId){const t=y(),s=t.findIndex(e=>e.id===S.activePresetId);s>=0&&(t[s].params=e,h(t),S.loadedPresetParams={...e}),S.clearDirtyState(),S.renderPresets()}else S.createNewPreset(e)},resetPreset:()=>{if(!S.activePresetId)return;const e=f().find(e=>e.id===S.activePresetId);e&&S.loadPreset(e)},createNewPreset:e=>{const t=y(),s=`Preset ${t.length+1}`,o=crypto.randomUUID();t.push({id:o,name:s,isBuiltIn:!1,params:e}),h(t),S.activePresetId=o,S.loadedPresetParams={...e},S.renderPresets(),S.clearDirtyState(),S.startRename(o)},newPreset:()=>{S.createNewPreset(b())},startRename:e=>{const t=document.querySelector(`.preset[data-preset-id="${e}"]`);if(!t)return;const s=y(),o=s.find(t=>t.id===e);if(!o)return;const c=document.createElement("input");c.type="text",c.value=o.name,c.className="preset-name-input";const a=()=>{const t=c.value.trim()||o.name,a=s.findIndex(t=>t.id===e);a>=0&&(s[a].name=t,h(s)),S.renderPresets()};c.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),a()),"Escape"===e.key&&S.renderPresets()}),c.addEventListener("blur",a),t.innerHTML="",t.appendChild(c),c.focus(),c.select()},setUpPresets:()=>{S.setUpShowHide();const e=document.querySelector(".preset-row");e?(S.renderPresets(),e.addEventListener("click",S.handlePresetRowClick),document.querySelector(".preset-save-btn")?.addEventListener("click",S.savePreset),document.querySelector(".preset-reset-btn")?.addEventListener("click",S.resetPreset)):document.querySelectorAll(".preset").forEach(e=>{e.addEventListener("click",()=>{switch(e.innerHTML){case"1":S.setPreset(0,0,100,10,50,1,22,25,2,22,0,0,0,0,"sine","sine");break;case"2":S.setPreset(0,7,55,10,50,1,9.18,18,4,12.91,6,5,0,0,"sine","sine");break;case"3":S.setPreset(32,7,55,10,40,1,16.74,55,3,12.89,3.5,6,6,76,"sawtooth","triangle");break;case"4":S.setPreset(0,7,55,10,40,1,9.18,55,2,12.91,2,2,8.5,84,"triangle","triangle");break;case"5":S.setPreset(0,5,0,10,40,1,9.18,55,3,18.88,0,0,0,0,"sawtooth","triangle");break;case"6":S.setPreset(24,0,100,10,40,1,6.62,55,3,11.83,3.5,2,1.5,45,"square","sawtooth")}S.clearActivePreset(),e.classList.add("active")})})},setPreset:(e,t,s,o,c,a,n,r,i,l,m,p,v,y,h,f)=>{d(u("attack"),e,!0),d(u("decay"),t,!0),d(u("sustain"),s,!0),d(u("release"),o,!0),d(u("oscVolume","1"),c,!0),d(u("oscVolume","2"),r,!0),d(u("octave","1"),a,!0),d(u("octave","2"),i,!0),d(u("cutoff","1"),n,!0),d(u("cutoff","2"),l,!0),d(u("tremolo-speed"),v,!0),d(u("tremolo-depth"),y,!0),d(u("vibrato-speed"),m,!0),d(u("vibrato-depth"),p,!0),document.querySelector(`.osctype[data-type="${h}"][data-osc="1"]`)?.click(),document.querySelector(`.osctype[data-type="${f}"][data-osc="2"]`)?.click()},setUpKeyboard:()=>{const e=document.querySelector(".keyboard");if(!e)return;let t=null;const s=new Map,o=e=>{g.context.resume(),g.start({n:e,down:!1,action:()=>{}}),S.pushKey(e)},c=e=>{g.stop(e),S.releaseKey(e)};e.addEventListener("mousedown",e=>{const s=e.target.closest("[data-key]");if(!s)return;const c=parseInt(s.dataset.key??"");isNaN(c)||(e.preventDefault(),t=c,o(c))}),e.addEventListener("mouseover",e=>{if(null===t)return;const s=e.target.closest("[data-key]");if(!s)return;const a=parseInt(s.dataset.key??"");isNaN(a)||a===t||(c(t),t=a,o(a))}),document.addEventListener("mouseup",()=>{null!==t&&(c(t),t=null)}),e.addEventListener("touchstart",e=>{const t=e;t.preventDefault();for(const e of Array.from(t.changedTouches)){const t=document.elementFromPoint(e.clientX,e.clientY),c=t?.closest("[data-key]");if(!c)continue;const a=parseInt(c.dataset.key??"");isNaN(a)||s.has(e.identifier)||(s.set(e.identifier,a),o(a))}},{passive:!1});const a=e=>{for(const t of Array.from(e.changedTouches)){const e=s.get(t.identifier);void 0!==e&&(c(e),s.delete(t.identifier))}};document.addEventListener("touchend",a),document.addEventListener("touchcancel",a)},start:()=>{const e=document.querySelector("#canvas"),t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=Math.round(s.width*t),e.height=Math.round(s.height*t);const o=S.keys;S.setUpPresets(),S.setUpKnobs(),S.setUpOscillatorTypes(),S.setUpKeyboard(),document.querySelector(".preset-row")?S.loadPreset(f()[0]):document.querySelector(".preset")?.click(),requestAnimationFrame(S.animate),document.addEventListener("keydown",e=>{S.synth.context.resume();const t=o[e.keyCode];if(t){if(t.down)return;t.down=!0,t.action(t)}}),document.addEventListener("keyup",e=>{const t=o[e.keyCode];if(t){if(t.down=!1,"octave"===t.type)return;const e=t.n;t.incremented?(S.synth.stop(t.origin??e),S.releaseKey(e),t.incremented=!1):(S.synth.stop(e),S.releaseKey(e))}}),S.synth.tremoloLfo.connect(S.synth.tremoloAmp),S.synth.tremoloAmp.connect(S.synth.volume.gain.gain),S.synth.volume.connect(S.synth.compressor),S.synth.compressor.connect(S.synth.context.destination),S.synth.tremoloLfo.start()}};document.addEventListener("DOMContentLoaded",()=>S.start())})();
//# sourceMappingURL=bundle.js.map